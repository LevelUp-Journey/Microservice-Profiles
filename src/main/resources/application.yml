# ===================================================
# Spring Application Configuration
# ===================================================
spring:
    application:
        name: profile-service
    profiles:
        active: local

    # ===================================================
    # PostgreSQL Configuration
    # ===================================================
    datasource:
        url: ${POSTGRES_URL}
        username: ${POSTGRES_USERNAME}
        password: ${POSTGRES_PASSWORD}
        driver-class-name: org.postgresql.Driver
    jpa:
        hibernate:
            ddl-auto: update
        open-in-view: false
        properties:
            hibernate:
                dialect: org.hibernate.dialect.PostgreSQLDialect
                format_sql: false
        show-sql: true

    # ===================================================
    # Docker Compose Configuration
    # ===================================================
    docker:
        compose:
            enabled: false

    # ===================================================
    # Kafka Configuration (Estructura igual a iam-service)
    # ===================================================
    kafka:
        bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS}

        # --- Propiedades globales de seguridad (válidas para producer y consumer) ---
        properties:
            security.protocol: ${KAFKA_SECURITY_PROTOCOL:PLAINTEXT}
            sasl.mechanism: ${KAFKA_SASL_MECHANISM:}
            sasl.jaas.config: ${KAFKA_SASL_JAAS_CONFIG:}

        # --- Configuración del Productor ---
        producer:
            key-serializer: org.apache.kafka.common.serialization.StringSerializer
            value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
            properties:
                max.block.ms: 2000
                request.timeout.ms: 2000
                delivery.timeout.ms: 3000
                spring:
                    json:
                        add:
                            type:
                                headers: false

        # --- Configuración del Consumidor ---
        consumer:
            group-id: ${KAFKA_CONSUMER_GROUP_ID:profile-service-group}
            auto-offset-reset: earliest
            enable-auto-commit: true
            key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
            value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
            properties:
                spring:
                    json:
                        trusted:
                            packages: "*"
                        type:
                            mapping: "userRegistered:com.levelup.journey.platform.microserviceprofiles.profiles.infrastructure.messaging.dto.UserRegisteredEvent"

# ===================================================
# Swagger & OpenAPI Configuration
# ===================================================
springdoc:
    api-docs:
        path: /v3/api-docs
    swagger-ui:
        path: /swagger-ui.html
        enabled: true
        disable-swagger-default-url: true

# ===================================================
# OpenAPI Documentation
# ===================================================
documentation:
    application:
        description: Level Up Journey - Profiles Management Microservice for user profile and gamification features.
        version: 1.0.0

# ===================================================
# Server Configuration
# ===================================================
server:
    port: ${PORT:8082}

# ===================================================
# App Custom Configuration
# ===================================================
app:
    kafka:
        enabled: ${KAFKA_ENABLED:true}
        topics:
            user-registered: ${KAFKA_TOPIC_USER_REGISTERED:iam.user.registered}
            challenge-completed: ${KAFKA_TOPIC_CHALLENGE_COMPLETED:challenge.completed}
            community-registration: ${KAFKA_TOPIC_COMMUNITY_REGISTRATION:community.registration}
            community-profile-updated: ${KAFKA_TOPIC_COMMUNITY_PROFILE_UPDATED:community.profile.updated}
    cors:
        allowed-origins: "http://localhost:3000,http://localhost:8080"
        allowed-methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
        allowed-headers: "*"
        allow-credentials: true
        max-age: 3600

    jwt:
        secret: ${JWT_SECRET}
        expiration: ${JWT_EXPIRATION:86400000}

# ===================================================
# Eureka Client Configuration
# ===================================================
eureka:
    client:
        service-url:
            defaultZone: ${SERVICE_DISCOVERY_URL:http://service-discovery:8761/eureka/}
        register-with-eureka: true
        fetch-registry: true
        registry-fetch-interval-seconds: 10 # sincroniza lista de servicios cada 10s
        healthcheck:
            enabled: true # usa health endpoint para validación real

    instance:
        prefer-ip-address: true
        lease-renewal-interval-in-seconds: 10 # envía heartbeat cada 10s
        lease-expiration-duration-in-seconds: 30 # Eureka espera 30s antes de eliminarlo
        instance-id: ${spring.application.name}:${server.port}:${random.value}
        metadata-map:
            zone: default

# ===================================================
# Management & Actuator Configuration
# ===================================================
management:
    endpoints:
        web:
            exposure:
                include: health,info,metrics,prometheus
    endpoint:
        health:
            show-details: when-authorized
    health:
        defaults:
            enabled: true
